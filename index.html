<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planning Sportif</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .team-logo {
      width: 30px;
      height: 30px;
      object-fit: contain;
    }
    .vs {
      font-weight: bold;
      font-size: 1.2rem;
      margin: 0 10px;
    }
    .live-indicator {
      color: red;
      font-weight: bold;
    }
    .card {
      border-radius: 1rem;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="text-center mb-4">🏟️ Planning Sportif</h1>

  <!-- Filtres -->
  <div class="row mb-4">
    <div class="col-md-4">
      <label class="form-label">⚽ Sport</label>
      <select id="sportSelect" class="form-select">
        <option value="all">Tous</option>
        <option value="football">Football</option>
        <option value="basketball">Basketball</option>
        <option value="rugby">Rugby</option>
        <option value="F1">F1</option>
        <option value="MotoGP">MotoGP</option>
        <option value="WRC">WRC</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">📅 Jour</label>
      <select id="daySelect" class="form-select">
        <option value="0">Aujourd'hui</option>
        <option value="1">Demain</option>
        <option value="2">Après-demain</option>
      </select>
    </div>
    <div class="col-md-4 d-flex align-items-end">
      <button class="btn btn-outline-primary w-100" id="weekBtn">🔁 Afficher toute la semaine</button>
    </div>
  </div>

  <!-- Liste des matchs -->
  <div id="match-list" class="row g-4"></div>

  <!-- Formulaire admin -->
  <div class="mt-5">
    <h4>➕ Ajouter un événement (admin)</h4>
    <form id="eventForm" class="row g-3">
      <div class="col-md-4">
        <input type="text" class="form-control" placeholder="Sport (ex: football)" id="formSport" required>
      </div>
      <div class="col-md-4">
        <input type="text" class="form-control" placeholder="Compétition" id="formCompetition" required>
      </div>
      <div class="col-md-4">
        <input type="date" class="form-control" id="formDate" required>
      </div>
      <div class="col-md-3">
        <input type="time" class="form-control" id="formHeure" required>
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" placeholder="Équipe domicile" id="formDomicile" required>
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" placeholder="Équipe extérieur" id="formExterieur" required>
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" placeholder="Chaîne (ex: beIN)" id="formChaine">
      </div>
      <div class="col-md-6">
        <input type="url" class="form-control" placeholder="Lien chaîne (si payante)" id="formLienChaine">
      </div>
      <div class="col-md-3">
        <select class="form-select" id="formPayant">
          <option value="false">Gratuit</option>
          <option value="true">Payant</option>
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" id="formLive">
          <option value="false">Non en direct</option>
          <option value="true">En direct</option>
        </select>
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-success">Ajouter</button>
      </div>
    </form>
  </div>
</div>

<!-- Firebase SDK + JS -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBToR5BXaPHsg8GgMosJBMompqUU1LBGG8",
    authDomain: "planning-sports.firebaseapp.com",
    projectId: "planning-sports",
    storageBucket: "planning-sports.appspot.com",
    messagingSenderId: "808656601330",
    appId: "1:808656601330:web:02c6c6c54e4cc705d6d06b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const sportSelect = document.getElementById("sportSelect");
  const daySelect = document.getElementById("daySelect");
  const weekBtn = document.getElementById("weekBtn");
  const matchList = document.getElementById("match-list");

  let showWeek = false;

  const getDateWithOffset = offset => {
    const d = new Date();
    d.setDate(d.getDate() + offset);
    return d.toISOString().split("T")[0];
  };

  async function fetchEvents() {
    const snapshot = await getDocs(collection(db, "evenements"));
    return snapshot.docs.map(doc => doc.data());
  }

  function getCountdown(dateStr, timeStr) {
    const matchDate = new Date(`${dateStr}T${timeStr}`);
    const now = new Date();
    const diff = matchDate - now;
    if (diff <= 0) return `<span class="live-indicator">🔴 En direct</span>`;
    const min = Math.floor((diff / 1000 / 60) % 60);
    const hr = Math.floor((diff / 1000 / 60 / 60));
    return `Débute dans ${hr}h ${min}min`;
  }

  async function renderMatches() {
    const sport = sportSelect.value;
    const dayOffset = parseInt(daySelect.value);
    const targetDate = getDateWithOffset(dayOffset);
    const all = await fetchEvents();

    let filtered = all.filter(e => sport === "all" || e.sport === sport);
    if (!showWeek) {
      filtered = filtered.filter(e => e.date === targetDate);
    }

    matchList.innerHTML = "";
    if (!filtered.length) {
      matchList.innerHTML = "<p class='text-center'>Aucun événement</p>";
      return;
    }

    filtered.forEach(e => {
      const countdown = e.enCours === "true" || e.enCours === true
        ? `<span class="live-indicator">🔴 En direct</span>`
        : getCountdown(e.date, e.heure);

      const chaine = e.chaine
        ? (e.payant === "true" || e.payant === true
            ? `<a href="${e.lienChaine}" target="_blank">📺 ${e.chaine} (payant)</a>`
            : `📺 ${e.chaine}`)
        : "—";

      matchList.innerHTML += `
        <div class="col-md-6">
          <div class="card p-3 shadow-sm">
            <h6 class="text-muted">${e.competition} — ${e.date} à ${e.heure}</h6>
            <div class="d-flex align-items-center justify-content-between">
              <div>${e.domicile}</div>
              <div class="vs">vs</div>
              <div>${e.exterieur}</div>
            </div>
            <p class="mt-2">${chaine}</p>
            <p class="text-primary">${countdown}</p>
          </div>
        </div>
      `;
    });
  }

  sportSelect.addEventListener("change", renderMatches);
  daySelect.addEventListener("change", () => {
    showWeek = false;
    renderMatches();
  });
  weekBtn.addEventListener("click", () => {
    showWeek = true;
    renderMatches();
  });

  // Formulaire d'ajout
  document.getElementById("eventForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const newEvent = {
      sport: formSport.value,
      competition: formCompetition.value,
      date: formDate.value,
      heure: formHeure.value,
      domicile: formDomicile.value,
      exterieur: formExterieur.value,
      chaine: formChaine.value,
      lienChaine: formLienChaine.value,
      payant: formPayant.value === "true",
      enCours: formLive.value === "true"
    };
    await addDoc(collection(db, "evenements"), newEvent);
    alert("✅ Événement ajouté !");
    renderMatches();
    e.target.reset();
  });

  setInterval(renderMatches, 60000);
  renderMatches();
</script>
</body>
</html>
