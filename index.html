<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planning Sportif 🔥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .team-logo { width: 30px; height: 30px; object-fit: contain; }
    .live-badge { color: red; font-weight: bold; margin-left: 10px; }
    #adminPanel { display: none; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">📅 Planning Sportif Multisport</h1>

    <div class="text-end mb-2">
      <button id="loginBtn" class="btn btn-outline-primary btn-sm">Connexion Admin 🔐</button>
      <button id="logoutBtn" class="btn btn-outline-danger btn-sm d-none">Déconnexion</button>
    </div>

    <div id="adminPanel" class="mb-4 border rounded p-3 bg-white shadow-sm">
      <h5>➕ Ajouter un match</h5>
      <form id="matchForm" class="row g-2">
        <input type="text" class="form-control" placeholder="Sport" id="sport" required>
        <input type="text" class="form-control" placeholder="Compétition" id="competition" required>
        <input type="date" class="form-control" id="date" required>
        <input type="time" class="form-control" id="time" required>
        <input type="text" class="form-control" placeholder="Équipe Domicile" id="homeName" required>
        <input type="url" class="form-control" placeholder="Logo Domicile" id="homeLogo" required>
        <input type="text" class="form-control" placeholder="Équipe Extérieure" id="awayName" required>
        <input type="url" class="form-control" placeholder="Logo Extérieure" id="awayLogo" required>
        <input type="text" class="form-control" placeholder="Chaîne TV" id="channelName" required>
        <input type="url" class="form-control" placeholder="Lien Streaming (si payant)" id="channelUrl">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="channelPaid">
          <label class="form-check-label" for="channelPaid">Chaîne payante</label>
        </div>
        <button type="submit" class="btn btn-success mt-2">Ajouter</button>
      </form>
    </div>

    <div id="match-list" class="row g-4"></div>
  </div>

  <script type="module">
    import { db, auth } from './firebase-config.js';
    import { collection, addDoc, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const matchList = document.getElementById("match-list");
    const matchForm = document.getElementById("matchForm");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const adminPanel = document.getElementById("adminPanel");

    // Connexion Google Admin
    loginBtn.addEventListener("click", async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert("Erreur de connexion");
        console.error(err);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, user => {
      const isAdmin = user && user.email.endsWith("@gmail.com"); // tu peux adapter
      if (isAdmin) {
        adminPanel.style.display = "block";
        loginBtn.classList.add("d-none");
        logoutBtn.classList.remove("d-none");
      } else {
        adminPanel.style.display = "none";
        loginBtn.classList.remove("d-none");
        logoutBtn.classList.add("d-none");
      }
    });

    // Formulaire d'ajout de match
    matchForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        sport: sport.value,
        competition: competition.value,
        date: date.value,
        time: time.value,
        home: { name: homeName.value, logo: homeLogo.value, score: null },
        away: { name: awayName.value, logo: awayLogo.value, score: null },
        channel: {
          name: channelName.value,
          paid: channelPaid.checked,
          url: channelPaid.checked ? channelUrl.value : null
        }
      };
      try {
        await addDoc(collection(db, "matches"), data);
        alert("✅ Match ajouté");
        matchForm.reset();
      } catch (err) {
        console.error(err);
        alert("Erreur lors de l’ajout");
      }
    });

    // 🔄 Rendu en temps réel
    const q = query(
      collection(db, "matches"),
      where("date", ">=", new Date().toISOString().split('T')[0]),
      orderBy("date"),
      orderBy("time")
    );

    onSnapshot(q, (snapshot) => {
      const matches = snapshot.docs.map(doc => doc.data());
      matchList.innerHTML = "";

      if (matches.length === 0) {
        matchList.innerHTML = `<p class="text-center">Aucun match à venir</p>`;
        return;
      }

      matches.forEach(match => {
        const isLive = isMatchLive(match.date, match.time);
        const liveBadge = isLive ? `<span class="live-badge">🔴 EN DIRECT</span>` : "";

        matchList.innerHTML += `
          <div class="col-md-6">
            <div class="card shadow-sm p-3">
              <h6 class="text-muted">${match.sport} – ${match.competition} — ${match.date} ${liveBadge}</h6>
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <img src="${match.home.logo}" class="team-logo me-2">
                  <strong>${match.home.name}</strong>
                </div>
                <span>vs</span>
                <div class="d-flex align-items-center">
                  <strong>${match.away.name}</strong>
                  <img src="${match.away.logo}" class="team-logo ms-2">
                </div>
              </div>
              <p class="mt-2 mb-1">⏰ ${match.time}</p>
              <p class="mb-1">📺 ${match.channel.paid 
                ? `<a href="${match.channel.url}" target="_blank">${match.channel.name} (payant)</a>` 
                : match.channel.name}</p>
            </div>
          </div>
        `;
      });
    });

    function isMatchLive(dateStr, timeStr) {
      const now = new Date();
      const start = new Date(`${dateStr}T${timeStr}:00`);
      const end = new Date(start.getTime() + 2 * 60 * 60 * 1000);
      return now >= start && now <= end;
    }
  </script>
</body>
</html>

